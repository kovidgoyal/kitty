matrix:
    fast_finish: true
    include:
        - os: linux
          dist: trusty
          group: beta
          sudo: false
          env:
            - CC=gcc ASANLIB=libasan.so.0 ASAN_ARG=--asan PYTHON=python3
          language: python
          python: "3.5"
          addons:
            apt:
              packages:
                - libfreetype6-dev
                - libglew-dev
                - libxi-dev
                - libxrandr-dev
                - libxinerama-dev
                - libxcursor-dev

        - os: linux
          dist: trusty
          group: beta
          sudo: false
          env:
            - CC=clang RUN_FLAKE=1 PYTHON=python3
          language: python
          python: "3.5"
          addons:
            apt:
              packages:
                - libfreetype6-dev
                - libglew-dev
                - libxi-dev
                - libxrandr-dev
                - libxinerama-dev
                - libxcursor-dev
                - clang

        - os: osx
          language: generic
          env: SWBASE=/Users/Shared/buildbot/sw SW=$SWBASE/sw PATH=$SW/bin:$PATH

        # Not supported: https://github.com/travis-ci/travis-ci/issues/2312
        # - os: osx
        #   env: CC=clang PYTHON=python3
        #   language: python
        #   python: "3.5"

        - os: osx
          env: CC=clang PYTHON=python3 BREW_PYTHON=true
          language: generic

before_install: |
    set -e
    rvm get stable --auto-dotfiles
    if [[ "$TRAVIS_OS_NAME" == 'osx' ]] && [ -n "$BREW_PYTHON" ]; then
        brew update
        brew install python3
        brew install glfw
    fi
    set +e

install: |
    set -e
    if [[ "$RUN_FLAKE" == "1" ]]; then pip install flake8; fi
    if [[ "$TRAVIS_OS_NAME" == 'osx' ]]; then
        if [ -n "$SW" ]; then
            mkdir -p $SW;
            curl https://download.calibre-ebook.com/travis/kitty/osx.tar.xz | tar xJ -C $SW;
        fi
    else
        wget -O glfw-3.2.1.zip https://github.com/glfw/glfw/archive/3.2.1.zip
        unzip glfw-3.2.1.zip
        cd glfw-3.2.1
        cmake -DBUILD_SHARED_LIBS=ON -DGLFW_BUILD_EXAMPLES=OFF -DGLFW_BUILD_TESTS=OFF -DGLFW_BUILD_DOCS=OFF -DCMAKE_INSTALL_PREFIX=$HOME/glfw
        make
        make install
        cd ..
    fi
    pkg-config --cflags glfw3
    set +e

env:
    global:
        - PKG_CONFIG_PATH=$HOME/glfw/lib/pkgconfig
        - LD_LIBRARY_PATH=$HOME/glfw/lib
        - ASAN_OPTIONS=leak_check_at_exit=0
        - PYTHON=python3

before_script: |
    set -e
    $PYTHON setup.py build --debug $ASAN_ARG;
    set +e

script: |
    set -e
    export LD_PRELOAD=$ASANLIB
    $PYTHON setup.py test
    if [[ "$RUN_FLAKE" == "1" ]]; then
        flake8 --count .
    fi
    # Workaround for https://github.com/travis-ci/travis-ci/issues/6522
    set +e
